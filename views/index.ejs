<!-- views/index.ejs -->
<!DOCTYPE html>
<html data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= title %></title>
  
  <!-- Pico CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  
  <style>
    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --primary-focus: rgba(99, 102, 241, 0.125);
    }
    
    body {
      padding: 0;
      background: #fafafa;
    }
    
    main {
      max-width: 900px;
      padding: 2rem 1rem;
    }
    
    h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #1e293b;
    }
    
    .breadcrumbs {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #64748b;
      margin-bottom: 1.5rem;
    }
    
    .breadcrumbs a {
      text-decoration: none;
      color: #64748b;
      transition: color 0.2s;
    }
    
    .breadcrumbs a:hover {
      color: var(--primary);
    }
    
    .breadcrumbs span {
      color: #cbd5e1;
    }
    
    .action-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    
    .action-bar button {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      margin: 0;
      background: white;
      border: 1px solid #e2e8f0;
      color: #475569;
    }
    
    .action-bar button:hover {
      background: #f8fafc;
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .action-bar button.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .action-bar button.primary:hover {
      background: var(--primary-hover);
    }
    
    .action-bar form {
      margin: 0;
    }
    
    section {
      margin: 2rem 0;
    }
    
    section h2 {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
      margin-bottom: 0.75rem;
    }
    
    .item {
      background: white;
      padding: 0.875rem 1rem;
      margin: 0 0 0.5rem 0;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s;
    }
    
    .item:hover {
      border-color: var(--primary);
      box-shadow: 0 1px 3px rgba(99, 102, 241, 0.1);
    }
    
    .item-info {
      flex: 1;
      min-width: 0;
    }
    
    .item-name {
      font-size: 0.9375rem;
      font-weight: 500;
      color: #1e293b;
      margin-bottom: 0.25rem;
      word-break: break-word;
    }
    
    .item-name a {
      text-decoration: none;
      color: inherit;
      transition: color 0.2s;
    }
    
    .item-name a:hover {
      color: var(--primary);
    }
    
    .item-meta {
      font-size: 0.8125rem;
      color: #94a3b8;
      margin: 0;
    }
    
    .item button {
      margin: 0;
      padding: 0.375rem 0.75rem;
      font-size: 0.8125rem;
      background: transparent;
      border: 1px solid #e2e8f0;
      color: #64748b;
    }
    
    .item button:hover {
      background: #f8fafc;
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #94a3b8;
      font-size: 0.9375rem;
      background: white;
      border: 1px dashed #e2e8f0;
      border-radius: 8px;
    }
    
    dialog article {
      max-width: 420px;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    dialog article header h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1e293b;
    }
    
    dialog article h4 {
      font-size: 0.875rem;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .modal-form {
      margin: 1.5rem 0 0 0;
      padding-top: 1.5rem;
      border-top: 1px solid #f1f5f9;
    }
    
    .modal-form:first-of-type {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }
    
    .modal-form button,
    .modal-form a[role="button"] {
      width: 100%;
      margin: 0;
      padding: 0.625rem 1rem;
      font-size: 0.875rem;
    }
    
    input[type="text"],
    input[type="file"],
    select {
      font-size: 0.9375rem;
      border-color: #e2e8f0;
    }
    
    input[type="text"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-focus);
    }
    
    button[type="submit"] {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    button[type="submit"]:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
    }
    
    button.contrast {
      background: #ef4444;
      border-color: #ef4444;
    }
    
    button.contrast:hover {
      background: #dc2626;
      border-color: #dc2626;
    }
    
    #uploadProgress {
      text-align: center;
      padding: 1rem 0;
    }
    
    #uploadProgress p {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: #64748b;
    }
    
    progress {
      height: 8px;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1><%= title %></h1>
    
    <nav class="breadcrumbs">
      <a href="/">Home</a>
      <% breadcrumbs.forEach(folder => { %>
        <span>/</span>
        <a href="/folder/<%= folder.id %>"><%= folder.name %></a>
      <% }) %>
    </nav>
    
    <div class="action-bar">
      <button onclick="openUploadFileModal()" class="primary">Upload</button>
      <button onclick="openCreateFolderModal()">New Folder</button>
      <form action="/logout" method="post">
        <button type="submit">Logout</button>
      </form>
    </div>
    
    <!-- Upload File Modal -->
    <dialog id="uploadFile">
      <article>
        <header>
          <h3>Upload File</h3>
          <button aria-label="Close" onclick="closeUploadFileModal()"></button>
        </header>
        <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
            <input type="hidden" name="folderId" value="<%= currentFolder ? currentFolder.id : '' %>">
          <input type="file" name="avatar" required id="fileInput" />
          
          <div id="uploadProgress" style="display: none;">
            <progress></progress>
            <p id="uploadStatus">Uploading...</p>
          </div>
          
          <button type="submit" id="uploadBtn">Upload</button>
        </form>
      </article>
    </dialog>

    <!-- Create Folder Modal -->
    <dialog id="createFolder">
      <article>
        <header>
          <h3>Create Folder</h3>
          <button aria-label="Close" onclick="closeCreateFolderModal()"></button>
        </header>
        <form action="/folder/create" method="post">
          <input type="hidden" name="parentId" value="<%= currentFolder ? currentFolder.id : '' %>">
          <input type="text" name="folderName" placeholder="Folder name" required />
          <button type="submit">Create</button>
        </form>
      </article>
    </dialog>

    <!-- Folders -->
    <section>
      <h2>Folders</h2>
      <% if (userFolders && userFolders.length > 0) { %>
        <% userFolders.forEach(function(folder) { %>
          <div class="item">
            <div class="item-info">
              <div class="item-name">
                <a href="/folder/<%= folder.id %>">üìÅ <%= folder.name || 'Unnamed Folder' %></a>
              </div>
            </div>
            <button onclick="openFolderOptionsModal(<%= folder.id %>)">‚Ä¢‚Ä¢‚Ä¢</button>
          </div>

          <!-- Folder Options Modal -->
          <dialog id="folderOptionsModal-<%= folder.id %>">
            <article>
              <header>
                <h3><%= folder.name || 'Unnamed Folder' %></h3>
                <button aria-label="Close" onclick="closeFolderOptionsModal(<%= folder.id %>)"></button>
              </header>
              
              <div class="modal-form">
                <h4>Share Folder</h4>
                <form action="/folder/<%= folder.id %>/share" method="post">
                  <select name="duration" required>
                    <option value="1">1 day</option>
                    <option value="7">7 days</option>
                    <option value="30">30 days</option>
                    <option value="365">1 year</option>
                  </select>
                  <button type="submit">Generate Link</button>
                </form>
              </div>
              
              <div class="modal-form">
                <h4>Delete Folder</h4>
                <form action="/folder/<%= folder.id %>/delete" method="post" onsubmit="return confirmDelete(this, event)">
                  <button type="submit" class="contrast">Delete</button>
                </form>
              </div>
            </article>
          </dialog>
        <% }); %>
      <% } else { %>
        <div class="empty-state">
          No folders yet
        </div>
      <% } %>
    </section>

    <!-- Files -->
    <section>
      <h2>Files</h2>
      <% if (userFiles && userFiles.length > 0) { %>
        <% userFiles.forEach(function(file) { %>
          <div class="item" id="file-item-<%= file.id %>">
            <div class="item-info">
              <div class="item-name"><%= file.name || 'Unnamed File' %></div>
              <div class="item-meta">
                <%= formatFileSize(file.size) %> ¬∑ <%= new Date(file.createdAt).toLocaleDateString() %>
              </div>
            </div>
            <div class="file-preview">
                <% if (file.mimeType && file.mimeType.startsWith('image/')) { %>
                    <img src="/files/<%= file.id %>/preview" alt="<%= file.name %>">
                <% } %>
                <% if (file.mimeType && file.mimeType.startsWith('video/')) { %>
                    <video controls>
                        <source src="/files/<%= file.id %>/preview" type="<%= file.mimeType %>">
                        Your browser doesn't support video playback.
                    </video>
                <% } %>
                <% if (file.mimeType && file.mimeType.startsWith('audio/')) { %>
                    <audio controls>
                        <source src="/files/<%= file.id %>/preview" type="<%= file.mimeType %>">
                        Your browser doesn't support audio playback.
                    </audio>
                <% } %>
                <% if (file.mimeType === 'application/pdf') { %>
                    <a href="/files/<%= file.id %>/preview" target="_blank" class="secondary">
                         View PDF
                    </a>
                <% } %>
            </div>
            <button onclick="openOptionsModal(<%= file.id %>)">‚Ä¢‚Ä¢‚Ä¢</button>
          </div>

          <%
          function formatFileSize(bytes) {
            if (!bytes) return 'Unknown';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
          }
          %>

          <!-- File Options Modal -->
          <dialog id="optionsModal-<%= file.id %>">
            <article>
              <header>
                <h3><%= file.name || 'Unnamed File' %></h3>
                <button aria-label="Close" onclick="closeOptionsModal(<%= file.id %>)"></button>
              </header>
              
              <div class="modal-form">
                <a href="/files/<%= file.id %>/download" 
                   role="button" 
                   onclick="showDownloadProgress(this, event)">
                  Download
                </a>
              </div>

              <div class="modal-form">
                <form action="/files/<%= file.id %>/delete" method="post" onsubmit="return confirmDelete(this, event)">
                  <button type="submit" class="contrast">Delete</button>
                </form>
              </div>
            </article>
          </dialog>
        <% }); %>
      <% } else { %>
        <div class="empty-state">
          No files uploaded yet
        </div>
      <% } %>
    </section>
  </main>

  <script>
    function confirmDelete(form, event) {
      if (!confirm('Are you sure you want to delete this?')) {
        event.preventDefault();
        return false;
      }
      
      const button = form.querySelector('button');
      button.innerHTML = 'Deleting...';
      button.disabled = true;
      button.setAttribute('aria-busy', 'true');
      
      return true;
    }

    function showDownloadProgress(button, event) {
      const originalText = button.innerHTML;
      button.innerHTML = 'Downloading...';
      button.setAttribute('aria-busy', 'true');
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.removeAttribute('aria-busy');
      }, 3000);
    }

    document.getElementById('uploadForm')?.addEventListener('submit', function(e) {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a file');
        e.preventDefault();
        return;
      }
      
      const maxSize = 40 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File too large. Maximum size is 40MB.');
        e.preventDefault();
        return;
      }
      
      document.getElementById('uploadProgress').style.display = 'block';
      const btn = document.getElementById('uploadBtn');
      btn.disabled = true;
      btn.setAttribute('aria-busy', 'true');
      btn.textContent = 'Uploading...';
    });

    document.getElementById('uploadFile')?.addEventListener('close', function() {
      document.getElementById('uploadProgress').style.display = 'none';
      const btn = document.getElementById('uploadBtn');
      btn.disabled = false;
      btn.removeAttribute('aria-busy');
      btn.textContent = 'Upload';
      document.getElementById('uploadForm')?.reset();
    });

    function openUploadFileModal() {
      document.getElementById('uploadFile')?.showModal();
    }
    
    function closeUploadFileModal() {
      document.getElementById('uploadFile')?.close();
    }

    function openCreateFolderModal() {
      document.getElementById('createFolder')?.showModal();
    }
    
    function closeCreateFolderModal() {
      document.getElementById('createFolder')?.close();
    }
    
    function openOptionsModal(fileId) {
      document.getElementById(`optionsModal-${fileId}`)?.showModal();
    }
    
    function closeOptionsModal(fileId) {
      document.getElementById(`optionsModal-${fileId}`)?.close();
    }
    
    function openFolderOptionsModal(folderId) {
      document.getElementById(`folderOptionsModal-${folderId}`)?.showModal();
    }

    function closeFolderOptionsModal(folderId) {
      document.getElementById(`folderOptionsModal-${folderId}`)?.close();
    }
    
    document.querySelectorAll('dialog').forEach(dialog => {
      dialog.addEventListener('click', function(event) {
        if (event.target === this) {
          this.close();
        }
      });
    });
  </script>
</body>
</html>
